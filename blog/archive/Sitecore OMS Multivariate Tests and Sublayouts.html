


<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<!-- Mirrored from www.glass.lu/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 10 Jan 2019 10:13:45 GMT -->
<!-- Added by HTTrack -->

<!-- Mirrored from glass.lu/blog/archive/Sitecore OMS Multivariate Tests and Sublayouts by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 24 May 2021 11:25:48 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



    <link rel="stylesheet" href="../../content/plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../content/css/style.css">
    <link rel="stylesheet" href="../../https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../content/css/theme-colors/default.css">
    <link rel="stylesheet" href="../../content/plugins/sky-forms/version-2.0.1/css/custom-sky-forms.css">

    <link rel="stylesheet" href="../../content/plugins/parallax-slider/css/parallax-slider.css">

    <link rel="stylesheet" href="../../content/Site-Lessae52ae52.css?v=5" />
    <link rel="stylesheet" href="../../content/site.css">

    <title>Sitecore OMS Multivariate Tests and Sublayouts - Glass</title>

    <link rel="shortcut icon" href="../../-/media/Images/Common/Horizon-Bordered-BlazeOrange-250.png">
    <!-- JS Global Compulsory -->
    <script type="text/javascript" src="../../content/plugins/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../../content/plugins/jquery/jquery-migrate.min.js"></script>
    <script type="text/javascript" src="../../content/plugins/bootstrap/js/bootstrap.min.js"></script>

    <script src="../../content/Site.js"></script>
    <script src="//google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>
    <script type="text/javascript" src="../../content/plugins/parallax-slider/js/modernizr.js"></script>
    <script type="text/javascript" src="../../content/plugins/parallax-slider/js/jquery.cslider.js"></script>


</head>


<body class="metro  mvc ">

    <div class="wrapper">

        <div class="header header-sticky header-fixed-shrink">
            <div class="topbar">
            </div>

            <!-- Navbar -->
            <div class="navbar navbar-default mega-menu" role="navigation">
                <div class="container">
                    <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="fa fa-bars"></span>
                        </button>
                        <a class="navbar-brand" href="../../index.html">

                            <img src="../../-/media/Images/Common/Horizon-Bordered-BlazeOrange-2503ca73ca7.png?h=50&amp;w=50&amp;la=en&amp;hash=C5F3C6D5FCB00EBE826D80BE26742A4D078D12D4" id="logo-header" alt="" />
                            <span style="vertical-align: middle;">Glass</span>

                        </a>
                    </div>

                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse navbar-responsive-collapse">
                        <ul class="nav navbar-nav">

                            <li class="">

                                <a href="../../Support.html">Support</a>
                            </li>
                            <li class="">

                                <a href="../../Training.html">Training</a>
                            </li>
                            <li class="">

                                <a href="../../Blog.html">Blog</a>
                            </li>
                            <li class="">

                                <a href="../../Mapper.html">Glass.Mapper.Sc</a>
                            </li>
                            <li class="">

                                <a href="../../Rockstars.html">Our Backers</a>
                            </li>
                            <li class="">

                                <a href="../../About.html">About</a>
                            </li>
                        </ul>
                    </div><!--/navbar-collapse-->
                </div>
            </div>
            <!-- End Navbar -->
        </div>

            <div class="breadcrumbs">
                <div class="container">
                    <h1 class="pull-left">

                        Sitecore OMS Multivariate Tests and Sublayouts

                    </h1>

                </div><!--/container-->
            </div>

        


<div class="container content">
    <div class="row">
        
 

        
<div>
    
</div>
<div class="row">
    <div class="col-md-12">

        <div class="blog margin-bottom-40">
            <div class="blog-post-tags">
                <ul class="list-unstyled list-inline blog-info pull-right">
                    <li>
                        <h3>
                            <i class="fa fa-calendar"></i>
                            27 Aug 2010
                        </h3>
                    </li>

                        <li>
                            <h3>
                                <a href="../../About/Mike.html">
                                    <i class="fa fa-pencil"></i>
                                    Mike
                                </a>
                            </h3>
                        </li>
                </ul>
            </div>
        </div>
    </div>
</div>

            <img src="../../-/media/Images/Blogs/Archive/MV-Home9af19af1.png?h=161&amp;w=200&amp;la=en&amp;hash=DCA0D2E109B3E6C4EEEE8677F6C546CAEAC3F0E3" class="pull-right img-responsive img-bordered margin-bottom-10 margin-left-10" alt="">
    




<p class='lead'>This post has been migrated from <strong>www.experimentsincode.com</strong>, we apologise if some of the images or content is missing</p><div>

<strong>This post as been migrated, original date 26 Feb 2010</strong>

Sitecore have release the <a href="http://www.sitecore.net/Products/Sitecore-Online-Marketing-Suite.aspx" target="_blank">Online Marketing Suit</a>.  One of the nice aspects of OMS is that ability to test different page  content to see which content users respond best to, this is called  Multivariate testing.

I quickly show how this is setup. Firstly we create a the different  items that contain the content variations. So in the picture below you  can see that I have three different home nodes.

<a href="../../s400290293.websitehome.co.uk/wp-content/uploads/2010/08/MV-Home.html"><img class="alignnone size-full wp-image-166" title="MV-Home" src="../../-/media/Images/Blogs/Archive/MV-Home21252125.png?la=en" alt="" width="224" height="180"></a>
When the user visits the site they are taken to /sitecore/content/home  but they may see content from /sitecore/content/home2 and  /sitecore/content/home3. This content is injected by the multivariate  test.

Now I have my content the next step is to create the multivariate test.  This is setup using the Marketing Centre application. For this example I  have setup an incremental test strategy that simply picks the next  multivariate test item to display to the user:
<pre class="brush:c#">    public class IncrementalMultiVariateTestStrategy : IMultiVariateTestStrategy
    {
        const string _cookieName ="aegeagaegaeWeafea2";

        #region IMultiVariateTestStrategy Members

        public Item GetTestVariableItem(Item item, Item multiVariateTest)
        {

            if (!multiVariateTest.HasChildren) return null;
            int index = Cookie == -1? 0 : Cookie;

            if (index &gt;= multiVariateTest.Children.Count) index = 0;

            Cookie = index + 1;
            return multiVariateTest.Children[index];
        }

        #endregion

        private int Cookie
        {
            get
            {
                int i = -1;

                if(HttpContext.Current.Request.Cookies[_cookieName]!= null)
                    int.TryParse(HttpContext.Current.Request.Cookies[_cookieName].Value, out i);

                return i;
            }
            set
            {
                HttpContext.Current.Response.Cookies.Add(new HttpCookie(_cookieName, value.ToString()));
            }
        }
    }</pre>
The image below shows the setup in the Marketing Centre with each test variable pointing at the relevant node.

<a href="../../s400290293.websitehome.co.uk/wp-content/uploads/2010/08/MV-Marketing.html"><img class="alignnone size-full wp-image-167" title="MV-Marketing" src="../../-/media/Images/Blogs/Archive/MV-Marketing21252125.png?la=en" alt="" width="509" height="281"></a>
Now I just need to setup the Sample Rendering to use the test on the homepage:

<a href="../../s400290293.websitehome.co.uk/wp-content/uploads/2010/08/MV-Rendering.html"><img class="alignnone size-full wp-image-168" title="MV-Rendering" src="../../-/media/Images/Blogs/Archive/MV-Rendering21252125.png?la=en" alt="" width="362" height="332"></a>
So publishing the site and doing a couple of refreshes we can see that  the content of the sample rendering actually changes. So are  multivariate test works!!

<a href="../../s400290293.websitehome.co.uk/wp-content/uploads/2010/08/MV-webpage1.html"><img class="alignnone size-full wp-image-170" title="MV-webpage1" src="../../-/media/Images/Blogs/Archive/MV-webpage121252125.png?la=en" alt="" width="692" height="244"></a>
Ok so it works for XSLTs but what about a sublayout? Si I have created a simple sublayout with the following code behind:
<pre class="brush:c#">public partial class layouts_MVTest : System.Web.UI.UserControl
{
    protected void Page_Load(object sender, EventArgs e)
    {
        output.Text = "Sublayout: " + Sitecore.Context.Item["Title"];
    }
}</pre>
I have also updated the home item to include the sublayout and set the sublayout to use the multivariate test:

<a href="../../s400290293.websitehome.co.uk/wp-content/uploads/2010/08/MV-Sublayout1.html"><img class="alignnone size-full wp-image-169" title="MV-Sublayout1" src="../../-/media/Images/Blogs/Archive/MV-Sublayout121252125.png?la=en" alt="" width="392" height="274"></a>
Ok so saving this and publishing it we now get this output:

<a href="../../s400290293.websitehome.co.uk/wp-content/uploads/2010/08/MV-webpage2.html"><img class="alignnone size-full wp-image-171" title="MV-webpage2" src="../../-/media/Images/Blogs/Archive/MV-webpage221252125.png?la=en" alt="" width="604" height="307"></a>
Notice how the XSLT content changes but the sublayout content does not  change. So why does this happen? This is caused by how the Sublayouts  and XSLTs resolve the current item.

I suspect that most Sitecore developers (this is true of where I work  and for myself) are used to getting the current item via  Sitecore.Context.Item within a sublayout. However if you look at the  code that the XSLT uses to render itself  (Sitecore.Web.UI.WebControls.XslFile there is a GetItem method inherited  from the Sitecore.Web.UI.WebControl class. Within this method the  actual item passed to the XSLT is resolved based on the  WebControl.DataSource property. The Multivariate Test actually changes  the DataSource property to point at the new content item.

So how do we get this value in the our Sublayout? Well we have actually look at the parent control of our user control:
<pre class="brush:c#">Sitecore.Web.UI.WebControls.Sublayout parent = (Sitecore.Web.UI.WebControls.Sublayout)this.Parent;
string sourceItem = parent.DataSource;</pre>
This then gives us the ID of the item injected by the multivariate  tests. So what does this mean in terms of development? Well if you want  to use multivariate tests on a site that you already developed you will  have to replace any reference to Sitecore.Context.Item with a custom  solution that looks at the parents DataSource property:
<pre class="brush:c#">    public Item Source
    {
        get
        {
            Sitecore.Web.UI.WebControls.Sublayout parent = (Sitecore.Web.UI.WebControls.Sublayout)this.Parent;
            Guid sourceItem = new Guid(parent.DataSource);
            return Sitecore.Context.Database.GetItem( new Sitecore.Data.ID(sourceItem)) ?? Sitecore.Context.Item;        }

    }</pre>
What about sub-items, for example you have the following code in your XSLT:
<pre class="brush:xml">      &lt;ul&gt;
      &lt;xsl:for-each select="./item"&gt;
        &lt;li&gt;
          &lt;sc:text field="Title"&gt;&lt;/sc:text&gt;
        &lt;/li&gt;
      &lt;/xsl:for-each&gt;
    &lt;/ul&gt;</pre>
Well this actually just breaks as shown in this images below and only  works when the original item is requested. The solution is to proxy the  subitems below the new nodes:

<a href="../../s400290293.websitehome.co.uk/wp-content/uploads/2010/08/MV-webpage3.html"><img class="alignnone size-full wp-image-172" title="MV-webpage3" src="../../-/media/Images/Blogs/Archive/MV-webpage321252125.png?la=en" alt="" width="464" height="286"></a>
I have summarised the problems you will have to think about when using mutlivariate tests on your site:
<ul>
	<li>Sitecore.Context.Item -  any code that uses this reference will not  pick up multivariate test content. This code will need to be changed.</li>
	<li>Sub items don't exist - sub items may not exist beneath the  alternative content items. You will need to recreate to proxy these  items.</li>
	<li> Other items will not see the alternative content. E.g. if you have a  rendering in another item that relies on content in an item that is  using multivariate test this item will only see the original item and  not the alternative content.</li>
</ul>
The multivariate tests are a powerful addition to the Sitecore platform  but if you plan to use them on your site you need to think how they will  be used before you start coding. Their usage will determine how you  design both your renderings and sublayouts. For simplicity it is best to  only use multivariate tests on renderings and sublayouts that only have  a dependency on the current item.

</div>

    

    </div>
</div>

        <div class="footer-v1">
            <div class="footer">
                <div class="container">
                    <div class="row">
                        <!-- About -->
                        <div class="col-md-3 md-margin-bottom-40">
                            <div class="row text-center margin-bottom-10 margin-top-20">
                                <a href="../../index.html" class="">
                                    <img src="../../-/media/Images/Common/Horizon-Bordered-BlazeOrange-2503ca73ca7.png?h=50&amp;w=50&amp;la=en&amp;hash=C5F3C6D5FCB00EBE826D80BE26742A4D078D12D4" id="logo-header" alt="" />
                                </a>
                            </div>

                            <p>Glass is home to the #1 ORM for Sitecore. Glass.Mapper is the easiest way to map data from your Sitecore solution to your code.</p>
                        </div><!--/col-md-3-->
                        <!-- End About -->
                        <!-- Latest -->
                        <div class="col-md-3 md-margin-bottom-40">
                            <div class="headline">
                                <h2>Sponsored by</h2>
                            </div>
                            <a href="https://refractdns.com/">
                                <img src="../../-/media/Images/Tiles/RDNS_Logo_WithTextWhite.png" style="width: 100%" class="img-responsive">
                            </a>
                        </div><!--/col-md-3-->
                        <!-- End Latest -->
                        <!-- Link List -->
                        <div class="col-md-3 md-margin-bottom-40">
                            <div class="headline">
                                <h2>Useful Links</h2>
                            </div>
                            <ul class="list-unstyled link-list">
                                <li><a href="../../Blog.html">Blog</a><i class="fa fa-angle-right"></i></li>
                                <li><a href="../../Training.html">Training</a><i class="fa fa-angle-right"></i></li>
                                <li><a href="../../Mapper.html">Glass.Mapper.Sc</a><i class="fa fa-angle-right"></i></li>
                                <li><a href="../../Support.html">Support</a><i class="fa fa-angle-right"></i></li>
                            </ul>
                        </div><!--/col-md-3-->
                        <!-- End Link List -->
                        <!-- Address -->
                        <div class="col-md-3 map-img md-margin-bottom-40">
                            <div class="headline">
                                <h2>Contact Us</h2>
                            </div>
                            <address class="md-margin-bottom-40">
                                Twitter: <a class="element brand" href="http://twitter.com/@glasslu" target="_blank">@glasslu</a><br>
                                Email: <a class="element brand" href="mailto:hello@glass.lu">hello@glass.lu</a> <br />
                                M C Edwards Ltd trading as Glass<br />
                                Company No.:08641300 <br />
                            </address>
                        </div><!--/col-md-3-->
                        <!-- End Address -->
                    </div>
                </div>

            </div><!--/footer-->
        </div>
        <!-- 1/10/2019 8:47:53 AM -->
        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-55731850-1', 'auto');
            ga('send', 'pageview');

        </script>


        <div class="footer-v1">

            <div class="copyright">
                <div class="container">
                    <div class="row">
                        <div class="col-md-3">
                            <p>
                                2019 &copy; All Rights Reserved.
                            </p>
                        </div>
                        <div class="col-md-9">

                            <p>
                                <a href="../../-/media/Files/Privacy_Policy_and_Cookie_Policy_Europe.pdf">Privacy Policy</a> | <a href="../../-/media/Files/Website_TCs_Template.pdf">Terms and Conditions</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div><!--/copyright-->
        </div>

        <div class="hidden" id="perfResults">
            <li class="topbar-devider"></li>
            <li>
                <i class="fa fa-clock-o" title="Page Render Time"></i> 30
            </li>
            <li>
                <img src="content/icon-bbbbbb-16.html" title="Glass Time" style="width: 8px;"> 3
            </li>
            <li>
                <i class="fa fa-pencil-square-o" title="Glass items requested"></i> 13
            </li>
            <li>
                <i class="fa fa-cloud" title="Glass items from cache"></i> 10
            </li>
        </div>
        <script>
            (function ($) {

                $(function () {
                    var results = $("#perfResults");
                    var placeholder = $("#resultsReplaces");

                    var html = results.html();
                    placeholder.replaceWith(html);
                });
            })(jQuery);
        </script>




    </div>
</body>


<!-- Mirrored from glass.lu/blog/archive/Sitecore OMS Multivariate Tests and Sublayouts by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 24 May 2021 11:25:58 GMT -->
</html>



<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<!-- Mirrored from www.glass.lu/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 10 Jan 2019 10:13:45 GMT -->
<!-- Added by HTTrack -->

<!-- Mirrored from glass.lu/blog/archive/Sitecore MVC - Dependency Injection by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 24 May 2021 11:25:07 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



    <link rel="stylesheet" href="../../content/plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../content/css/style.css">
    <link rel="stylesheet" href="../../https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../content/css/theme-colors/default.css">
    <link rel="stylesheet" href="../../content/plugins/sky-forms/version-2.0.1/css/custom-sky-forms.css">

    <link rel="stylesheet" href="../../content/plugins/parallax-slider/css/parallax-slider.css">

    <link rel="stylesheet" href="../../content/Site-Lessae52ae52.css?v=5" />
    <link rel="stylesheet" href="../../content/site.css">

    <title>Sitecore MVC - Dependency Injection - Glass</title>

    <link rel="shortcut icon" href="../../-/media/Images/Common/Horizon-Bordered-BlazeOrange-250.png">
    <!-- JS Global Compulsory -->
    <script type="text/javascript" src="../../content/plugins/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../../content/plugins/jquery/jquery-migrate.min.js"></script>
    <script type="text/javascript" src="../../content/plugins/bootstrap/js/bootstrap.min.js"></script>

    <script src="../../content/Site.js"></script>
    <script src="//google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>
    <script type="text/javascript" src="../../content/plugins/parallax-slider/js/modernizr.js"></script>
    <script type="text/javascript" src="../../content/plugins/parallax-slider/js/jquery.cslider.js"></script>


</head>


<body class="metro  mvc ">

    <div class="wrapper">

        <div class="header header-sticky header-fixed-shrink">
            <div class="topbar">
            </div>

            <!-- Navbar -->
            <div class="navbar navbar-default mega-menu" role="navigation">
                <div class="container">
                    <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="fa fa-bars"></span>
                        </button>
                        <a class="navbar-brand" href="../../index.html">

                            <img src="../../-/media/Images/Common/Horizon-Bordered-BlazeOrange-2503ca73ca7.png?h=50&amp;w=50&amp;la=en&amp;hash=C5F3C6D5FCB00EBE826D80BE26742A4D078D12D4" id="logo-header" alt="" />
                            <span style="vertical-align: middle;">Glass</span>

                        </a>
                    </div>

                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse navbar-responsive-collapse">
                        <ul class="nav navbar-nav">

                            <li class="">

                                <a href="../../Support.html">Support</a>
                            </li>
                            <li class="">

                                <a href="../../Training.html">Training</a>
                            </li>
                            <li class="">

                                <a href="../../Blog.html">Blog</a>
                            </li>
                            <li class="">

                                <a href="../../Mapper.html">Glass.Mapper.Sc</a>
                            </li>
                            <li class="">

                                <a href="../../Rockstars.html">Our Backers</a>
                            </li>
                            <li class="">

                                <a href="../../About.html">About</a>
                            </li>
                        </ul>
                    </div><!--/navbar-collapse-->
                </div>
            </div>
            <!-- End Navbar -->
        </div>

            <div class="breadcrumbs">
                <div class="container">
                    <h1 class="pull-left">

                        Sitecore MVC - Dependency Injection

                    </h1>

                </div><!--/container-->
            </div>

        


<div class="container content">
    <div class="row">
        
 

        
<div>
    
</div>
<div class="row">
    <div class="col-md-12">

        <div class="blog margin-bottom-40">
            <div class="blog-post-tags">
                <ul class="list-unstyled list-inline blog-info pull-right">
                    <li>
                        <h3>
                            <i class="fa fa-calendar"></i>
                            10 Sep 2012
                        </h3>
                    </li>

                        <li>
                            <h3>
                                <a href="../../About/Mike.html">
                                    <i class="fa fa-pencil"></i>
                                    Mike
                                </a>
                            </h3>
                        </li>
                </ul>
            </div>
        </div>
    </div>
</div>

            
    




<p class='lead'>This post has been migrated from <strong>www.experimentsincode.com</strong>, we apologise if some of the images or content is missing</p>In the <a href="http://www.experimentsincode.com/?p=407">first blog</a> in the series I looked at how you could create a commenting component that you could associate with any item in Sitecore.

In this post we will look at how we can use IOC to create the controller and inject the services it needs, to do this I will be using <a href="http://www.castleproject.org/">Castle Windsor Container</a>. 

There isn't actually anything special about configuring an IOC for Sitecore's MVC solution since Sitecore delegates the resolution of controllers to the standard .NET MVC implementation. Most of the Windsor code I have taken from <a href="http://jcreamerlive.com/2011/06/21/dependency-injection-asp-net-mvc-3-castle-windsor/"> Jonathan Creamer's</a> blog.

First you need to create a controller factory that uses the IOC container:

<pre class="brush:csharp">
    public class WindsorControllerFactory : DefaultControllerFactory
    {
        private readonly IKernel _kernel;

        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        /// &lt;param name="kernel"&gt;&lt;/param&gt;
        public WindsorControllerFactory(IKernel kernel)
        {
            _kernel = kernel;
        }

        /// &lt;summary&gt;
        /// Release the controller at the end of it's life cycle
        /// &lt;/summary&gt;
        /// &lt;param name="controller"&gt;The Interface to an MVC controller&lt;/param&gt;
        public override void ReleaseController(IController controller)
        {
            _kernel.ReleaseComponent(controller);
        }

        /// &lt;summary&gt;
        /// Resolve a controller dependency
        /// &lt;/summary&gt;
        /// &lt;param name="requestContext"&gt;The HTTP context&lt;/param&gt;
        /// &lt;param name="controllerType"&gt;Type of controller to resolve&lt;/param&gt;
        /// &lt;returns&gt;IController&lt;/returns&gt;
        protected override IController GetControllerInstance(RequestContext requestContext, Type controllerType)
        {
            if (controllerType == null)
            {
                throw new HttpException(404, string.Format("The controller for path '{0}' could not be found.",
                    requestContext.HttpContext.Request.Path));
            }
            return (IController)_kernel.Resolve(controllerType);
        }
    }
</pre>

For Castle we can create an installer that will search our assembly for controllers:

<pre class="brush:csharp">
    public class ControllerInstaller : IWindsorInstaller
    {
        /// &lt;summary&gt;
        /// Installs the controllers
        /// &lt;/summary&gt;
        /// &lt;param name="container"&gt;&lt;/param&gt;
        /// &lt;param name="store"&gt;&lt;/param&gt;
        public void Install(IWindsorContainer container, IConfigurationStore store)
        {
            container.Register(FindControllers().Configure(x =&gt; { x.LifestyleTransient(); }));
        }

        /// &lt;summary&gt;
        /// Find controllers within this assembly in the same namespace as HomeController
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private BasedOnDescriptor FindControllers()
        {
            return AllTypes.FromThisAssembly()
                .BasedOn&lt;SitecoreController&gt;();
        }
    }
</pre>

Now we just need to update the Application_Start method in out Global.asax file, first we register the Glass configuration:

<pre class="brush:csharp">
            //register glass
            Glass.Sitecore.Mapper.Context context = new Glass.Sitecore.Mapper.Context(
                new Glass.Sitecore.Mapper.Razor.GlassModuleLoader(),
                new AttributeConfigurationLoader(
                    "Demo.Templates, Demo",
                    "Demo.Models, Demo"));
</pre>

Next instantiate the IOC container and configure it with the controllers and services it will need:

<pre class="brush:csharp">
            //setup the container
            WindsorContainer container = new WindsorContainer();

            //register the controllers
            container.Install(new ControllerInstaller());

            //register the Glass components
            container.Register(
                Component.For&lt;ISitecoreContext&gt;().ImplementedBy&lt;SitecoreContext&gt;().LifestyleTransient(),
                Component.For&lt;ISitecoreService&gt;().ImplementedBy&lt;SitecoreService&gt;().LifestyleTransient()
                    .DependsOn(Dependency.OnValue&lt;string&gt;("master"))
                );
</pre>

Finally configure .NET MVC to use our new  controller factory;

<pre class="brush:csharp">
            //setup the controller factory
            ControllerBuilder.Current.SetControllerFactory(new WindsorControllerFactory(container.Kernel));
</pre>

To test we need to alter the CommentsController class from the first example by removing the default constructor to just leave us with the constructor that handles dependency injection:

<pre class="brush:csharp">
    public class CommentController  : SitecoreController
    {
        ISitecoreContext _context;
        ISitecoreService _master;
        
        /// &lt;summary&gt;
        /// This constructor can be used with dependency injection or unit testing 
        /// &lt;/summary&gt;
        /// &lt;param name="context"&gt;&lt;/param&gt;
        public CommentController(ISitecoreContext context, ISitecoreService master) 
        {
            _context = context;
            _master = master;
        }

        [HttpGet]
        public override ActionResult Index()
        {
            var model = _context.GetCurrentItem&lt;CommentPage&gt;();
            return View(model);
        }

        [HttpPost]
        public ActionResult Index(Comment comment)
        {
            

            var webModel = _context.GetCurrentItem&lt;CommentPage&gt;();
            

            if (ModelState.IsValid && comment != null)
            {
                var masterModel = _master.GetItem&lt;CommentPage&gt;(webModel.Id);

                if (masterModel.CommentFolder == null)
                {
                    CommentFolder folder = new CommentFolder();
                    folder.Name = "Comments";

                    using (new SecurityDisabler())
                    {
                        _context.Create(masterModel, folder);
                    }
                    masterModel.CommentFolder = folder;
                }

                using (new SecurityDisabler())
                {
                    comment.Name = DateTime.Now.ToString("yyyyMMddhhmmss");

                    //create the comment in the master database
                    _master.Create(masterModel.CommentFolder, comment);
                    webModel.CommentAdded = true;
                }
            }

           
            return View(webModel);
        }
    }
</pre>

If we compile the solution and run the page we should find that we get the same result as before.




    

    </div>
</div>

        <div class="footer-v1">
            <div class="footer">
                <div class="container">
                    <div class="row">
                        <!-- About -->
                        <div class="col-md-3 md-margin-bottom-40">
                            <div class="row text-center margin-bottom-10 margin-top-20">
                                <a href="../../index.html" class="">
                                    <img src="../../-/media/Images/Common/Horizon-Bordered-BlazeOrange-2503ca73ca7.png?h=50&amp;w=50&amp;la=en&amp;hash=C5F3C6D5FCB00EBE826D80BE26742A4D078D12D4" id="logo-header" alt="" />
                                </a>
                            </div>

                            <p>Glass is home to the #1 ORM for Sitecore. Glass.Mapper is the easiest way to map data from your Sitecore solution to your code.</p>
                        </div><!--/col-md-3-->
                        <!-- End About -->
                        <!-- Latest -->
                        <div class="col-md-3 md-margin-bottom-40">
                            <div class="headline">
                                <h2>Sponsored by</h2>
                            </div>
                            <a href="https://refractdns.com/">
                                <img src="../../-/media/Images/Tiles/RDNS_Logo_WithTextWhite.png" style="width: 100%" class="img-responsive">
                            </a>
                        </div><!--/col-md-3-->
                        <!-- End Latest -->
                        <!-- Link List -->
                        <div class="col-md-3 md-margin-bottom-40">
                            <div class="headline">
                                <h2>Useful Links</h2>
                            </div>
                            <ul class="list-unstyled link-list">
                                <li><a href="../../Blog.html">Blog</a><i class="fa fa-angle-right"></i></li>
                                <li><a href="../../Training.html">Training</a><i class="fa fa-angle-right"></i></li>
                                <li><a href="../../Mapper.html">Glass.Mapper.Sc</a><i class="fa fa-angle-right"></i></li>
                                <li><a href="../../Support.html">Support</a><i class="fa fa-angle-right"></i></li>
                            </ul>
                        </div><!--/col-md-3-->
                        <!-- End Link List -->
                        <!-- Address -->
                        <div class="col-md-3 map-img md-margin-bottom-40">
                            <div class="headline">
                                <h2>Contact Us</h2>
                            </div>
                            <address class="md-margin-bottom-40">
                                Twitter: <a class="element brand" href="http://twitter.com/@glasslu" target="_blank">@glasslu</a><br>
                                Email: <a class="element brand" href="mailto:hello@glass.lu">hello@glass.lu</a> <br />
                                M C Edwards Ltd trading as Glass<br />
                                Company No.:08641300 <br />
                            </address>
                        </div><!--/col-md-3-->
                        <!-- End Address -->
                    </div>
                </div>

            </div><!--/footer-->
        </div>
        <!-- 1/10/2019 8:47:53 AM -->
        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-55731850-1', 'auto');
            ga('send', 'pageview');

        </script>


        <div class="footer-v1">

            <div class="copyright">
                <div class="container">
                    <div class="row">
                        <div class="col-md-3">
                            <p>
                                2019 &copy; All Rights Reserved.
                            </p>
                        </div>
                        <div class="col-md-9">

                            <p>
                                <a href="../../-/media/Files/Privacy_Policy_and_Cookie_Policy_Europe.pdf">Privacy Policy</a> | <a href="../../-/media/Files/Website_TCs_Template.pdf">Terms and Conditions</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div><!--/copyright-->
        </div>

        <div class="hidden" id="perfResults">
            <li class="topbar-devider"></li>
            <li>
                <i class="fa fa-clock-o" title="Page Render Time"></i> 30
            </li>
            <li>
                <img src="content/icon-bbbbbb-16.html" title="Glass Time" style="width: 8px;"> 3
            </li>
            <li>
                <i class="fa fa-pencil-square-o" title="Glass items requested"></i> 13
            </li>
            <li>
                <i class="fa fa-cloud" title="Glass items from cache"></i> 10
            </li>
        </div>
        <script>
            (function ($) {

                $(function () {
                    var results = $("#perfResults");
                    var placeholder = $("#resultsReplaces");

                    var html = results.html();
                    placeholder.replaceWith(html);
                });
            })(jQuery);
        </script>




    </div>
</body>


<!-- Mirrored from glass.lu/blog/archive/Sitecore MVC - Dependency Injection by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 24 May 2021 11:25:07 GMT -->
</html>